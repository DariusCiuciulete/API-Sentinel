{% extends "base.html" %}

{% block title %}Monitoring - API Sentinel{% endblock %}

{% block content %}
<div class="flex justify-between items-center mb-3">
    <h1>üìä API Monitoring</h1>
    <div class="flex gap-1">
        <button onclick="runMonitoring()" class="btn btn-success" id="runBtn">Run Monitoring Now</button>
    </div>
</div>

<!-- Monitoring Statistics -->
<div class="grid grid-4 mb-3">
    <div class="card stat-card">
        <div class="stat-label">Total Checks (24h)</div>
        <div class="stat-value">{{ monitoring_stats.total_checks }}</div>
    </div>
    <div class="card stat-card">
        <div class="stat-label">Availability</div>
        <div class="stat-value" style="color: var(--success-color);">{{ monitoring_stats.availability }}%</div>
    </div>
    <div class="card stat-card">
        <div class="stat-label">Avg Response Time</div>
        <div class="stat-value" style="color: var(--primary-color);">{{ monitoring_stats.avg_response_time }}ms</div>
    </div>
    <div class="card stat-card">
        <div class="stat-label">Failed Checks</div>
        <div class="stat-value" style="color: var(--danger-color);">{{ monitoring_stats.failed_checks }}</div>
    </div>
</div>

<!-- Status Message -->
<div id="statusMessage" style="display: none;"></div>

<!-- Endpoints Monitoring Table -->
<div class="card">
    <div class="card-header">
        <h2 class="card-title">Monitored Endpoints</h2>
    </div>
    <div class="card-body">
        {% if endpoints %}
        <div class="table-container">
            <table>
                <thead>
                    <tr>
                        <th>Service</th>
                        <th>Endpoint</th>
                        <th>Status</th>
                        <th>Last Check</th>
                        <th>Response Time</th>
                        <th>Status Code</th>
                        <th>Interval</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody>
                    {% for endpoint in endpoints %}
                    <tr>
                        <td><strong>{{ endpoint.service_name }}</strong></td>
                        <td>
                            <span class="badge badge-info">{{ endpoint.method }}</span>
                            <code>{{ endpoint.path }}</code>
                        </td>
                        <td>
                            {% if endpoint.last_result %}
                                {% if endpoint.last_result.success %}
                                <span class="badge badge-success">‚úì Healthy</span>
                                {% else %}
                                <span class="badge badge-danger">‚úó Failed</span>
                                {% endif %}
                            {% else %}
                            <span class="badge badge-warning">Not Checked</span>
                            {% endif %}
                        </td>
                        <td>
                            {% if endpoint.last_result %}
                            {{ endpoint.last_result.checked_at }}
                            {% else %}
                            Never
                            {% endif %}
                        </td>
                        <td>
                            {% if endpoint.last_result and endpoint.last_result.response_time_ms %}
                            {{ "%.2f"|format(endpoint.last_result.response_time_ms) }}ms
                            {% else %}
                            -
                            {% endif %}
                        </td>
                        <td>
                            {% if endpoint.last_result and endpoint.last_result.status_code %}
                            <span class="badge badge-info">{{ endpoint.last_result.status_code }}</span>
                            {% else %}
                            -
                            {% endif %}
                        </td>
                        <td>
                            {% if endpoint.config %}
                            {{ endpoint.config.check_interval_seconds }}s
                            {% else %}
                            Not configured
                            {% endif %}
                        </td>
                        <td>
                            <div class="flex gap-1">
                                <button onclick="testEndpoint({{ endpoint.id }})" class="btn btn-sm btn-primary">Test Now</button>
                                <button onclick="showConfigModal({{ endpoint.id }})" class="btn btn-sm btn-secondary">Configure</button>
                            </div>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
        {% else %}
        <p class="text-center" style="color: var(--text-secondary); padding: 2rem;">
            No active endpoints to monitor. <a href="/inventory">Go to Inventory</a> to activate endpoints.
        </p>
        {% endif %}
    </div>
</div>

<!-- Configuration Modal -->
<div id="configModal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1000;">
    <div style="position: relative; max-width: 600px; margin: 50px auto; background: white; border-radius: 8px; padding: 2rem;">
        <h2>Configure Monitoring</h2>
        <form id="configForm" onsubmit="saveConfig(event)">
            <input type="hidden" name="endpoint_id" id="config_endpoint_id">
            
            <div class="form-group">
                <label class="form-label">Check Interval (seconds)</label>
                <input type="number" name="check_interval_seconds" id="check_interval" class="form-control" value="300" min="60" required>
                <small>How often to check this endpoint (minimum 60 seconds)</small>
            </div>
            
            <div class="form-group">
                <label class="form-label">Timeout (seconds)</label>
                <input type="number" name="timeout_seconds" id="timeout" class="form-control" value="30" min="5" max="120" required>
                <small>Maximum time to wait for response</small>
            </div>
            
            <div class="form-group">
                <label class="form-label">Latency Threshold (ms)</label>
                <input type="number" name="latency_threshold_ms" id="latency_threshold" class="form-control" value="1000" min="100" required>
                <small>Alert if response time exceeds this value</small>
            </div>
            
            <div class="form-group">
                <label class="form-label">Error Rate Threshold (%)</label>
                <input type="number" name="error_rate_threshold" id="error_rate_threshold" class="form-control" value="10" min="0" max="100" step="0.1" required>
                <small>Alert if error rate exceeds this percentage</small>
            </div>
            
            <div class="flex gap-1">
                <button type="submit" class="btn btn-primary">Save Configuration</button>
                <button type="button" onclick="hideConfigModal()" class="btn btn-secondary">Cancel</button>
            </div>
        </form>
    </div>
</div>

<script>
async function runMonitoring() {
    const btn = document.getElementById('runBtn');
    const statusDiv = document.getElementById('statusMessage');
    
    btn.disabled = true;
    btn.textContent = 'Running...';
    
    statusDiv.style.display = 'block';
    statusDiv.innerHTML = '<div class="alert alert-info">Running monitoring checks on all active endpoints...</div>';
    
    try {
        const response = await fetch('/monitoring/run', {
            method: 'POST'
        });
        
        const result = await response.json();
        
        if (result.success) {
            statusDiv.innerHTML = `<div class="alert alert-success">‚úÖ ${result.message}<br>Total: ${result.total}, Successful: ${result.successful}, Failed: ${result.failed}</div>`;
            setTimeout(() => {
                window.location.reload();
            }, 2000);
        } else {
            statusDiv.innerHTML = `<div class="alert alert-danger">‚ùå ${result.message}</div>`;
        }
    } catch (error) {
        statusDiv.innerHTML = `<div class="alert alert-danger">‚ùå Error: ${error}</div>`;
    } finally {
        btn.disabled = false;
        btn.textContent = 'Run Monitoring Now';
    }
}

async function testEndpoint(endpointId) {
    const statusDiv = document.getElementById('statusMessage');
    
    statusDiv.style.display = 'block';
    statusDiv.innerHTML = '<div class="alert alert-info">Testing endpoint...</div>';
    
    try {
        const response = await fetch(`/monitoring/test/${endpointId}`, {
            method: 'POST'
        });
        
        const result = await response.json();
        
        if (result.success) {
            statusDiv.innerHTML = `<div class="alert alert-success">‚úÖ Test successful<br>Status: ${result.status_code}, Response Time: ${result.response_time_ms.toFixed(2)}ms</div>`;
        } else {
            statusDiv.innerHTML = `<div class="alert alert-danger">‚ùå Test failed: ${result.error || 'Unknown error'}</div>`;
        }
        
        setTimeout(() => {
            statusDiv.style.display = 'none';
        }, 5000);
    } catch (error) {
        statusDiv.innerHTML = `<div class="alert alert-danger">‚ùå Error: ${error}</div>`;
    }
}

function showConfigModal(endpointId) {
    document.getElementById('config_endpoint_id').value = endpointId;
    document.getElementById('configModal').style.display = 'block';
}

function hideConfigModal() {
    document.getElementById('configModal').style.display = 'none';
}

async function saveConfig(event) {
    event.preventDefault();
    const form = event.target;
    const formData = new FormData(form);
    const endpointId = formData.get('endpoint_id');
    
    // Convert error rate from percentage to decimal
    const errorRate = parseFloat(formData.get('error_rate_threshold')) / 100;
    formData.set('error_rate_threshold', errorRate);
    
    try {
        const response = await fetch(`/monitoring/configure/${endpointId}`, {
            method: 'POST',
            body: formData
        });
        
        const result = await response.json();
        
        if (result.success) {
            alert('Configuration saved successfully');
            hideConfigModal();
            window.location.reload();
        } else {
            alert('Error: ' + result.message);
        }
    } catch (error) {
        alert('Error saving configuration: ' + error);
    }
}
</script>
{% endblock %}
