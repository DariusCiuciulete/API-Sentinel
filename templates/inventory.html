{% extends "base.html" %}

{% block title %}API Inventory - API Sentinel{% endblock %}

{% block content %}
<div class="flex justify-between items-center mb-3">
    <h1>API Inventory</h1>
    <div class="flex gap-1">
        <a href="/inventory/export" class="btn btn-secondary btn-sm">Export CSV</a>
        <button onclick="showAddModal()" class="btn btn-primary btn-sm">Add Endpoint</button>
    </div>
</div>

<!-- Search Bar -->
<div class="card mb-3">
    <form method="get" action="/inventory">
        <div class="flex gap-1">
            <input type="text" name="search" class="form-control" placeholder="Search by service name, path, or method..." value="{{ search }}">
            <button type="submit" class="btn btn-primary">Search</button>
            {% if search %}
            <a href="/inventory" class="btn btn-secondary">Clear</a>
            {% endif %}
        </div>
    </form>
</div>

<!-- Inventory Table -->
<div class="card">
    <div class="card-header">
        <h2 class="card-title">All Endpoints ({{ endpoints|length }})</h2>
    </div>
    <div class="card-body">
        {% if endpoints %}
        <div class="table-container">
            <table>
                <thead>
                    <tr>
                        <th>Service</th>
                        <th>Method</th>
                        <th>Endpoint</th>
                        <th>Description</th>
                        <th>Auth</th>
                        <th>Type</th>
                        <th>Status</th>
                        <th>Source</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody>
                    {% for endpoint in endpoints %}
                    <tr>
                        <td><strong>{{ endpoint.service_name }}</strong></td>
                        <td><span class="badge badge-info">{{ endpoint.method }}</span></td>
                        <td><code>{{ endpoint.path }}</code></td>
                        <td>{{ endpoint.description or '-' }}</td>
                        <td>{{ endpoint.auth_type or 'None' }}</td>
                        <td>
                            {% if endpoint.is_internal %}
                            <span class="badge badge-info">Internal</span>
                            {% else %}
                            <span class="badge badge-warning">External</span>
                            {% endif %}
                        </td>
                        <td>
                            {% if endpoint.is_active %}
                            <span class="badge badge-success">Active</span>
                            {% else %}
                            <span class="badge badge-danger">Inactive</span>
                            {% endif %}
                        </td>
                        <td><small>{{ endpoint.discovery_source or 'Unknown' }}</small></td>
                        <td>
                            <div class="flex gap-1">
                                <button onclick="toggleEndpoint({{ endpoint.id }})" class="btn btn-sm btn-secondary">Toggle</button>
                                <button onclick="editEndpoint({{ endpoint.id }})" class="btn btn-sm btn-secondary">Edit</button>
                                <button onclick="deleteEndpoint({{ endpoint.id }})" class="btn btn-sm btn-danger">Delete</button>
                            </div>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
        {% else %}
        <p class="text-center" style="color: var(--text-secondary); padding: 2rem;">
            No endpoints found. {% if not search %}<a href="/discovery">Start discovering APIs</a>{% endif %}
        </p>
        {% endif %}
    </div>
</div>

<!-- Add Endpoint Modal (simplified, inline) -->
<div id="addModal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1000;">
    <div style="position: relative; max-width: 600px; margin: 50px auto; background: white; border-radius: 8px; padding: 2rem;">
        <h2>Add New Endpoint</h2>
        <form id="addForm" onsubmit="addEndpoint(event)">
            <div class="form-group">
                <label class="form-label">Service Name</label>
                <input type="text" name="service_name" class="form-control" required>
            </div>
            <div class="form-group">
                <label class="form-label">Base URL</label>
                <input type="url" name="base_url" class="form-control" required>
            </div>
            <div class="form-group">
                <label class="form-label">Path</label>
                <input type="text" name="path" class="form-control" required placeholder="/api/endpoint">
            </div>
            <div class="form-group">
                <label class="form-label">Method</label>
                <select name="method" class="form-control" required>
                    <option value="GET">GET</option>
                    <option value="POST">POST</option>
                    <option value="PUT">PUT</option>
                    <option value="DELETE">DELETE</option>
                    <option value="PATCH">PATCH</option>
                </select>
            </div>
            <div class="form-group">
                <label class="form-label">Description</label>
                <textarea name="description" class="form-control"></textarea>
            </div>
            <div class="form-group">
                <label class="form-label">Authentication Type</label>
                <input type="text" name="auth_type" class="form-control" placeholder="e.g., Bearer, API Key">
            </div>
            <div class="form-group">
                <label><input type="checkbox" name="is_internal"> Internal API</label>
            </div>
            <div class="flex gap-1">
                <button type="submit" class="btn btn-primary">Add Endpoint</button>
                <button type="button" onclick="hideAddModal()" class="btn btn-secondary">Cancel</button>
            </div>
        </form>
    </div>
</div>

<script>
function showAddModal() {
    document.getElementById('addModal').style.display = 'block';
}

function hideAddModal() {
    document.getElementById('addModal').style.display = 'none';
}

async function addEndpoint(event) {
    event.preventDefault();
    const form = event.target;
    const formData = new FormData(form);
    
    try {
        const response = await fetch('/inventory/add', {
            method: 'POST',
            body: formData
        });
        
        const result = await response.json();
        
        if (result.success) {
            alert(result.message);
            window.location.reload();
        } else {
            alert('Error: ' + (result.message || 'Unknown error'));
        }
    } catch (error) {
        alert('Error adding endpoint: ' + error);
    }
}

async function toggleEndpoint(id) {
    try {
        const response = await fetch(`/inventory/toggle/${id}`, {
            method: 'POST'
        });
        
        const result = await response.json();
        
        if (result.success) {
            window.location.reload();
        } else {
            alert('Error: ' + result.message);
        }
    } catch (error) {
        alert('Error toggling endpoint: ' + error);
    }
}

async function deleteEndpoint(id) {
    if (!confirm('Are you sure you want to delete this endpoint?')) {
        return;
    }
    
    try {
        const response = await fetch(`/inventory/delete/${id}`, {
            method: 'POST'
        });
        
        const result = await response.json();
        
        if (result.success) {
            window.location.reload();
        } else {
            alert('Error: ' + result.message);
        }
    } catch (error) {
        alert('Error deleting endpoint: ' + error);
    }
}

function editEndpoint(id) {
    alert('Edit functionality coming soon. For now, you can toggle active status or delete and re-add.');
}
</script>
{% endblock %}
